{% extends "bootstrap_responsive.html" %}
{% block style %}
{{ super() }}
        <style>
        .item {
            float:left;
            width:220px;
            margin:10px;
        }
        </style>
{% endblock %}
{% block body_content %}
        <header class="navbar navbar-inverse navbar-fixed-top row">
            <h2 class="span2">Pls</h2>
            {% if current_user.is_authenticated() %}
            <h2 class="span4"><i class="icon-user"></i>{{ current_user.name }}</h2>
            <div class="span6" id="image_uploader_container">
                <input id="file_uploader" type="file" name="file"/>
                <button>post image</button>
            </div>
            <div class="2" id='logout_container'><i class="icon-off"></i><a href="{{ url_for('gallery.logout') }}">logout</a></div>
            {% else %}
            <form method="post">
                <input type="text" name="username"/>
                <input type="password" name="password"/>
                <input type="submit" value="sign in"/>
            </form>
            {% endif %}
        </header>
        <script type="text/javascript" src="{{ url_for('gallery.static', filename='jquery.min.js') }}"></script>
        <script type="text/javascript" src="{{ url_for('gallery.static', filename='jquery.masonry.min.js') }}"></script>
        <script type="text/javascript" src="{{ url_for('static', filename='socket.io.js') }}"></script>
        <script type="text/javascript">
        (function(){
            var socket = io.connect('http://localhost:8080/default');
            var file_uploader = document.getElementById('file_uploader');
            var fileReader;

            socket.on('connect', function(){
                console.log('connect');
            })

            socket.on('stream', function() {
                var f = uploaded_file.slice();

                fileReader.readAsBinaryString(f)
            });

            socket.on('error', function(data) {
                alert(data);
            });

            //socket.emit('localized');I//
            if(!window.File || !window.FileReader) {
                alert('please use a modern browser that implements File and FileReader API');
                return false;
            }

            var uploaded_file;

            function on_file_chose(evt) {
                fileReader = new FileReader();
                console.log(evt);
                fileReader.onload = function(evt) {
                    console.log('onload: ');
                    console.log(evt);
                    socket.emit('upload', {chunk: evt.target.result});
                }

                uploaded_file = evt.target.files[0]

                socket.emit('start', {size: uploaded_file.size, name: file_uploader.value});
            }

            file_uploader.addEventListener('change', on_file_chose);
        })();
        $(function(){
            var $container = $('#container');
            $container.imagesLoaded(function() {
                $container.masonry({
                    // options
                    itemSelector : '.item',
                    columnWidth : 240
                });
            });
        });
        </script>
{% endblock %}
